# API設計書記載ルール

## 1. 全体の構成

### 1.1. エンドポイントの基本構造

全APIのエンドポイントは、以下の構造を基本とする。

`/api/v1/{リソース名}/<アクション>`

- **API Versioning:** v1
- **Resource:** テーブル物理名もしくはドメインコンテキスト(機能モジュール)を表現する名詞。

例:

| リソース名 | 意味するコンテキスト          | 責務の範囲                                                                                             |
| ---------- | ----------------------------- | ------------------------------------------------------------------------------------------------------ |
| users      | エンティティ(永続化対象)      | ユーザーテーブルに対するCRUD操作                                                                       |
| contracts  | エンティティ(永続化対象)      | 契約テーブルに対するCRUD操作                                                                           |
| auth       | 認証サービス(機能/プロセス)   | 認証トークンの発行、ログイン処理、パスワードリセットなど、ユーザーテーブル操作ではない認証ロジック全体 |
| email      | メールサービス(機能/プロセス) | 外部サービスを介したメール送信プロセス                                                                 |

API個別設計書ファイル名は、`{リソース名}_<アクション>.md`の形式で命名する。視認性のための順番管理はAPI一覧で行う。

例:

| 機能         | エンドポイント           | ファイル名          | 備考                                                                       |
| ------------ | ------------------------ | ------------------- | -------------------------------------------------------------------------- |
| ログイン     | `/api/vi/auth/login`     | `auth_login.md`     | 認証サービスに紐づくアクションのため、「auth」がリソース名となる。         |
| ユーザー作成 | `/api/v1/users/create`   | `users_create.md`   | ユーザーテーブルに紐づくアクションのため、テーブル物理名がリソースとなる。 |
| 契約一覧取得 | `/api/v1/contracts/list` | `contracts_list.md` | 契約テーブルに紐づくアクションのため、テーブル物理名がリソースとなる。     |

### 1.2. 取得系 API (Read)

Select文の軸となるテーブルに対してAPIを作成する。

| 形式     | エンドポイント名 | 役割                                                  |
| -------- | ---------------- | ----------------------------------------------------- |
| 配列取得 | list             | 複数レコードの一覧を取得 (検索・ページネーション対応) |
| 個別取得 | detail           | 1レコードの詳細を取得 (関連明細を含む場合あり)        |

#### 1.2.1. POSTによる取得処理の許可 (簡易的な情報隠蔽)

- **目的:** 日本国内のエンタープライズシステム設計の慣習に基づき、URLパラメータからの簡易的な情報隠蔽措置として、取得系APIは原則POSTで実装する。
- **仕様:** POSTを使用する場合、検索条件(GETメソッドにおけるクエリパラメータ)はリクエストボディに格納されるものとする。
- **適用例:** `/api/v1/users/list` や `/api/v1/orders/list` など、一覧系APIでの利用を想定する。

### 1.3. 登録系 API (Write)

登録対象となるテーブルに対してAPIを作成する。エンドポイント名はリソース名(テーブル物理名)の直下とする。

| 形式 | エンドポイント名 | 役割                            |
| ---- | ---------------- | ------------------------------- |
| 登録 | create           | 対象テーブルに1レコード登録する |

- **親子関係の同時登録:** ヘッダと明細のような親子関係にあるテーブルに同時に登録する場合、**親リソースのPOST**で子リソースのデータを登録する。(例: 注文ヘッダ/明細の同時登録は `/orders/create`で実行する)

### 1.4. 更新系 API (Update)

更新対象となるテーブルに対してAPIを作成する。エンドポイント名はリソース名(テーブル物理名)の直下とする。

| 形式 | エンドポイント名 | 役割                                |
| ---- | ---------------- | ----------------------------------- |
| 更新 | update           | 1レコードの特定フィールドを更新する |

#### 1.4.1. PUT と PATCH の使い分け

更新系APIでは、以下のポリシーで PUT と PATCH を使い分ける。

##### PUT (全項目更新/リソースの完全な置き換え)

- **役割:** クライアントが提供したデータで、リソースの表現を完全に置き換える。
- **クライアントの意図:** リソースの全フィールド(クライアントが変更可能なもの)を提供する。
- **適用:** プロファイル設定画面など、全項目が入力対象であり、未指定項目を意図的に空にしたい場合に用いる。
- **重要な原則:** 下記の項目は、テーブルの主キーもしくは監査項目のため、「全項目」の意味の対象外とする。

| 項目論理名 | 項目物理名(DB側) | 役割                                           |
| ---------- | ---------------- | ---------------------------------------------- |
| ID         | id               | レコードを一意に識別する。更新してはならない。 |
| 登録日時   | registered_at    | レコードが作成された日時のタイムスタンプを示す |
| 登録者     | registered_by    | レコードの登録者を示す                         |
| 更新日時   | updated_at       | レコードが更新された日時のタイムスタンプを示す |
| 更新者     | updated_by       | レコードの更新者を示す                         |
| 削除フラグ | is_deleted       | レコードが論理削除されていることを示す         |

##### PATCH (部分更新)

- **役割:** リソースの特定フィールドのみを部分的に変更する。
- **クライアントの意図:** 変更したいフィールドのみを含める。リクエストに含めなかったフィールドは、変更されず、既存値が維持される。
- **適用:** プルダウンによるステータスの修正など、項目ごとに個別にリアルタイムに情報を更新したい場合に用いる。

## 2. API一覧

APIの基本情報を下記のフォーマットに従って定義する。

| No  | API名(個別設計書へのリンク)           | エンドポイント         | メソッド      | 系統 | 認証要否 | 備考                                                 |
| --- | ------------------------------------- | ---------------------- | ------------- | ---- | -------- | ---------------------------------------------------- |
| 101 | [ログイン](./auth_login.md)           | `/api/v1/auth/login`   | `POST`        | 取得 | 不要     |                                                      |
| 201 | [ユーザー一覧取得](./users_list.md)   | `/api/v1/users/list`   | `POST`        | 取得 | 要       | ユーザー一覧                                         |
| 202 | [ユーザー詳細取得](./users_detail.md) | `/api/v1/users/detail` | `POST`        | 取得 | 要       | IDによる単一検索                                     |
| 203 | [ユーザー情報登録](./users_create.md) | `/api/v1/users/create` | `POST`        | 登録 | 要       | -                                                    |
| 204 | [ユーザー情報更新](./users_update.md) | `/api/v1/users/update` | `PUT`/`PATCH` | 更新 | 要       | 論理削除は`PATCH`として実現                          |
| 205 | [ユーザー情報削除](./users_delete.md) | `/api/v1/users/delete` | `DELETE`      | 削除 | 要       | 物理削除(画面提供しない想定だが、サンプルとして記載) |

※Noは順番管理に用いるため、トビを許容する。

## 3. API個別定義書の構成

### 3.1. API個別定義書の項目

すべての個別設計書は以下の項目で構成する。

| 項目             | 概要                                                                                                            |
| ---------------- | --------------------------------------------------------------------------------------------------------------- |
| API名            | APIの論理的な名称                                                                                               |
| エンドポイント   | APIのURL (例: /api/v1/users/list)                                                                               |
| 認証要否         | 要/不要                                                                                                         |
| メソッド         | HTTPメソッド (GET, POST, PUT, DELETE, PATCH)                                                                    |
| データ形式       | リクエストボディの形式 (JSON, `multipart/form-data` 等)                                                         |
| リクエストヘッダ | 認証トークンやコンテンツタイプなどの定義                                                                        |
| リクエスト       | リクエスト形式、必須/任意項目、型、制約                                                                         |
| 処理概要         | 個別のAPI機能定義書名。ファイルへのハイパーリンクを付加する。あるいは、APIの機能を100文字程度で簡潔に説明する。 |
| レスポンス       | レスポンス形式、フィールド名、型、説明                                                                          |
| エラー定義       | HTTPステータスコードとエラーレスポンスの定義                                                                    |

### 3.2. API個別設計書の項目記載方法

#### API名

API一覧の記載と一致させること。

#### エンドポイント

API一覧の記載と一致させること。

#### 認証要否

API一覧の記載と一致させること。

#### メソッド

API一覧の記載と一致させること。

#### データ形式

`application/json` または `multipart/form-data` など、リクエストボディのContent-Typeを明確に記載する。

#### リクエストヘッダ

| 項目名          | 必須 | 値の例             | 備考                                 |
| --------------- | ---- | ------------------ | ------------------------------------ |
| `Authorization` | 必須 | `Bearer xxx...`    | 認証トークン。認証要否に従う。       |
| `Content-Type`  | 必須 | `application/json` | データ形式の項目で規定される値とする。 |

#### リクエスト

リクエスト項目の論理名・物理名を下記のフォーマットで記載する。オブジェクト・配列で入れ子となる場合は個別に切り出して定義する。

DBカラムと直接紐づくことが前提の項目に関しては、DBの物理名(snake_caseで定義されている)をcamelCaseに置き換えたものを物理名とする。また、紐づき先のテーブル・カラムを論理名で定義する。

##### リクエスト(配列取得)の定義例

```markdown
### ルートオブジェクト

| 論理名 | 物理名      | 型     | DBテーブル | DBカラム | 必須 | 最小桁数 | 最大桁数 | フォーマット | 最小値 | 最大値 | 備考                                   |
| ------ | ----------- | ------ | ---------- | -------- | ---- | -------- | -------- | ------------ | ------ | ------ | -------------------------------------- |
| 注文日 | orderDate   | date   | 注文       | 注文日   | 任意 | -        | -        | -            | -      | -      |                                        |
| 合計額 | totalAmount | number | -          | -        | 任意 | -        | -        | -            | 1      | 999    | 合計額は動的に計算するためDBに持たない想定 |

```

##### リクエスト(個別取得)の定義例

```markdown
### ルートオブジェクト

| 論理名 | 物理名 | 型     | DBテーブル | DBカラム | 必須 | 最小桁数 | 最大桁数 | フォーマット | 最小値 | 最大値 | 備考             |
| ------ | ------ | ------ | ---------- | -------- | ---- | -------- | -------- | ------------ | ------ | ------ | ---------------- |
| 注文ID | id     | string | 注文       | ID       | 必須 | 36       | 36       | UUID         | -      | -      | 注文テーブルのID |
````

※一覧画面から詳細画面を表示するといった場合のリクエストを想定。

##### リクエスト(登録系)の定義例

```markdown
### ルートオブジェクト

| 論理名   | 物理名    | 型    | DBテーブル | DBカラム | 必須 | 最小桁数 | 最大桁数 | フォーマット | 最小値 | 最大値 | 備考                       |
| -------- | --------- | ----- | ---------- | -------- | ---- | -------- | -------- | ------------ | ------ | ------ | -------------------------- |
| 注文日   | orderDate | date  | 注文       | 注文日   | 必須 | -        | -        | -            | -      | -      |                            |
| 注文明細 | items     | array | -          | -        | 必須 | -        | -        | -            | 1      | 50     | 注文に含まれる明細のリスト |

#### 注文明細

| 論理名     | 物理名     | 型     | DBテーブル | DBカラム | 必須 | 最小桁数 | 最大桁数 | フォーマット | 最小値 | 最大値 | 備考                 |
| ---------- | ---------- | ------ | ---------- | -------- | ---- | -------- | -------- | ------------ | ------ | ------ | -------------------- |
| サービスID | servicesId | string | サービス   | ID       | 必須 | 36       | 36       | UUID         | -      | -      | 注文するサービスのID |
| 数量       | quantity   | number | 注文       | 注文数   | 必須 | -        | -        | -            | 1      | 999    |                      |
```

##### リクエスト(更新系)の定義例

```markdown
### ルートオブジェクト

| 論理名   | 物理名 | 型     | DBテーブル | DBカラム | 必須 | 最小桁数 | 最大桁数 | フォーマット | 最小値 | 最大値 | 備考                       |
| -------- | ------ | ------ | ---------- | -------- | ---- | -------- | -------- | ------------ | ------ | ------ | -------------------------- |
| 注文ID   | id     | number | Y          | ID       | 必須 | 36       | 36       | UUID         | -      | -      | 更新対象の注文ID           |
| 注文明細 | items  | array  | N          | -        | 必須 | -        | -        | -            | 1      | 50     | 注文に含まれる明細のリスト |

#### 注文明細

| 論理名     | 物理名     | 型     | DBテーブル | DBカラム | 必須 | 最小桁数 | 最大桁数 | フォーマット | 最小値 | 最大値 | 備考 |
| ---------- | ---------- | ------ | ---------- | -------- | ---- | -------- | -------- | ------------ | ------ | ------ | ---- |
| 注文明細ID | id         | string | 注文明細   | ID       | 必須 | 36       | 36       | UUID         | -      | -      |      |
| サービスID | servicesId | string | サービス   | ID       | 必須 | 36       | 36       | UUID         | -      | -      |      |
| 数量       | quantity   | number | 注文   | 注文数   | 必須 | -        | -        | -            | 1      | 999    |      |
```

#### レスポンス

リクエスト項目の論理名・物理名を下記のフォーマットで記載する。オブジェクト・配列で入れ子となる場合は個別に切り出して定義する。レスポンス項目の物理名はcamelCaseで記載すること。

##### 成功時のレスポンス(取得系)

- **レスポンスコード** `200 OK`

- **レスポンス**

```markdown
### ルートオブジェクト

| 論理名     | 物理名      | 型     | DBテーブル | DBカラム | 備考 |
| ---------- | ----------- | ------ | ---------- | -------- | ---- |
| 注文ID     | orderId     | string | 注文       | ID       |      |
| 注文日     | orderDate   | date   | 注文       | 注文日   |      |
| 合計金額   | totalAmount | number | -          | -        |      |
| 注文者情報 | user        | object | -          | -        |      |
| 注文明細   | items       | array  | -          | -        |      |

#### 注文者情報

| 論理名         | 物理名 | 型     | DB       | DBカラム       | 備考 |
| -------------- | ------ | ------ | -------- | -------------- | ---- |
| ユーザーID     | userId | string | ユーザー | ID             |      |
| ユーザー名     | name   | string | ユーザー | 氏名           |      |
| メールアドレス | email  | string | ユーザー | メールアドレス |      |

#### 注文明細

| 論理名     | 物理名      | 型     | DB       | DBカラム   | 備考 |
| ---------- | ----------- | ------ | -------- | ---------- | ---- |
| 明細ID     | lineItemId  | string | 注文明細 | ID         |      |
| サービス名 | serviceName | string | 注文明細 | サービス名 |      |
| 単価       | price       | number | 注文明細 | 単価       |      |
| 数量       | quantity    | number | 注文明細 | 注文数     |      |
```

- **0件時のレスポンス**

  - 配列取得(`/list`)の場合
    - **レスポンスコード** `200 OK`
    - **レスポンス** 空の配列を返す。

  - 個別取得(`/detail`)の場合
    - **レスポンスコード** `404 NOT FOUND`
    - **レスポンス** なし。`404 NOT FOUND`を受領した後の責務(エラー表示、空白等)は受領側の責務とする。

##### 成功時のレスポンス(登録系)

- **レスポンスコード** `201 CREATED`

- **レスポンス**

###### ルートオブジェクト

| 論理名     | 物理名      | 型     | DBテーブル | DBカラム | 備考 |
| ---------- | ----------- | ------ | ---------- | -------- | ---- |
| 注文ID     | orderId     | string | 注文       | ID       |      |

##### 成功時のレスポンス(更新系)

- **レスポンスコード** `204 NO CONTENT`

- **レスポンス** なし

##### 成功時のレスポンス(削除系)

- **レスポンスコード** `204 NO CONTENT`

- **レスポンス** なし

#### エラー定義

| HTTPステータスコード      | エラーメッセージ(必須)       | エラーメッセージ詳細(任意) | 発生条件                                                   |
| ------------------------- | ---------------------------- | -------------------------- | ---------------------------------------------------------- |
| 400 BAD REQUEST           | 入力内容に誤りがあります     | 〇〇は必須です             | バリデーションエラー(例: 必須項目不足、文字数オーバーなど) |
| 401 UNAUTHORIZED          | 認証情報が無効です           | -                          | 認証が必要なAPIでトークンが無効または未送信の場合          |
| 404 NOT FOUND             | 対象のデータが見つかりません | -                          | 個別取得APIで指定IDのデータが存在しない場合                |
| 409 CONFLICT              | 既に登録済みの情報です       | -                          | 登録系APIで一意制約(例: メールアドレス)に違反した場合      |
| 500 INTERNAL SERVER ERROR | システムエラーが発生しました | -                          | 予期せぬサーバー内部エラー(DB接続失敗など)               |

##### エラーレスポンスの共通フォーマット

すべてのエラーレスポンスは以下の共通JSONフォーマットで返却する。

```json
{
"message": "入力内容に誤りがあります",
"details": "ユーザー名は1文字以上50文字以下で入力してください"
}
```

(C)2025 Ryo ICHIKAWA
