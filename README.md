# scms-api-doc

本書は、[simple-contract-management-system](https://github.com/ryo-ichikawa-0308/simple-contract-management-system)のAPI定義ルールを記載したものです。

READMEの原則に従って設計したAPI設計のサンプルを含みます。

APIはNestJSで実装することを前提とします。

## 1. 全体のルール

### 1.1. エンドポイントの基本構造

全APIのエンドポイントは、以下の構造を基本とする。

`/api/v1/{テーブル物理名}/<アクション>`

- **API Versioning:** v1
- **Resource:** データベースのテーブル物理名 (例: users, contracts)

### 1.2. 取得系 API (Read)

Select文の軸となるテーブルに対してAPIを作成する。

| 形式     | エンドポイント名 | 役割                                                  |
| -------- | ---------------- | ----------------------------------------------------- |
| 配列取得 | list             | 複数レコードの一覧を取得 (検索・ページネーション対応) |
| 個別取得 | detail           | 1レコードの詳細を取得 (関連明細を含む場合あり)        |

#### 1.2.1. POSTによる取得処理の許可 (簡易的な情報隠蔽)

- **目的:** 大量の検索条件を含める場合、または検索条件に機密性の高い情報を含む場合に、URLパラメータからの簡易的な情報隠蔽措置として、取得系APIをPOSTメソッドで実装することを許可する。
- **仕様:** POSTを使用する場合、検索条件(GETメソッドにおけるクエリパラメータ)はリクエストボディに格納されるものとする。
- **適用例:** `/api/v1/users/list` や `/api/v1/orders/list` など、一覧系APIでの利用を想定する。

### 1.3. 登録系 API (Write)

登録対象となるテーブルに対してAPIを作成する。エンドポイント名はリソース名(テーブル物理名)の直下とする。

| 形式 | エンドポイント名 | 役割                            |
| ---- | ---------------- | ------------------------------- |
| 登録 | create           | 対象テーブルに1レコード登録する |

- **親子関係の同時登録:** ヘッダと明細のような親子関係にあるテーブルに同時に登録する場合、**親リソースのPOST**で子リソースのデータを配列として含めて登録する。(例: 注文ヘッダ/明細の同時登録は `/orders/create`で実行する)

### 1.4. 更新系 API (Update)

更新対象となるテーブルに対してAPIを作成する。エンドポイント名はリソース名(テーブル物理名)の直下とする。

| 形式     | エンドポイント名 | 役割                                |
| -------- | ---------------- | ----------------------------------- |
| 個別更新 | update           | 1レコードの特定フィールドを更新する |

#### 1.4.1. PUT と PATCH の使い分け

更新系APIでは、以下のポリシーで PUT と PATCH を使い分ける。

##### PUT (全項目更新/リソースの完全な置き換え)

- **役割:** クライアントが提供したデータで、リソースの表現を完全に置き換える。
- **クライアントの意図:** リソースの全フィールド(クライアントが変更可能なもの)を提供する。
- **適用:** プロファイル設定画面など、全項目が入力対象であり、未指定項目を意図的に空にしたい場合に用いる。
- **重要な原則:** 下記の項目は、テーブルの主キーもしくは監査項目のため、「全項目」の意味の対象外とする。

| 項目論理名 | 項目物理名(DB側) | 役割                                           |
| ---------- | ---------------- | ---------------------------------------------- |
| ID         | id               | レコードを一意に識別する。更新してはならない。 |
| 登録日時   | registered_at    | レコードが作成された日時のタイムスタンプを示す |
| 登録者     | registered_by    | レコードの登録者を示す                         |
| 更新日時   | updated_at       | レコードが更新された日時のタイムスタンプを示す |
| 更新者     | updated_by       | レコードの更新者を示す                         |
| 削除フラグ | is_deleted       | レコードが論理削除されていることを示す         |

##### PATCH (部分更新)

- **役割:** リソースの特定フィールドのみを部分的に変更する。
- **クライアントの意図:** 変更したいフィールドのみを含める。リクエストに含めなかったフィールドは、変更されず、既存値が維持される。
- **適用:** プルダウンによるステータスの修正など、項目ごとに個別にリアルタイムに情報を更新したい場合に用いる。

## 2. API一覧

データベース定義書に基づき、主要なCRUD操作を想定してエンドポイントを定義する。

| API名(個別設計書へのリンク) | エンドポイント       | メソッド      | 系統 | 備考                        |
| --------------------------- | -------------------- | ------------- | ---- | --------------------------- |
| ユーザー一覧取得            | /api/v1/users/list   | `POST`        | 取得 | ユーザー一覧                |
| ユーザー詳細取得            | /api/v1/users/detail | `POST`        | 取得 | IDによる単一検索            |
| ユーザー情報登録            | /api/v1/users/create | `POST`        | 登録 | -                           |
| ユーザー情報更新            | /api/v1/users/update | `PUT`/`PATCH` | 更新 | 論理削除は`PATCH`として実現 |
| ユーザー情報削除            | /api/v1/users/delete | `DELETE`      | 削除 | 物理削除                    |

## 3. API個別定義書の構成

### 3.1. API個別定義書の項目

すべての個別設計書は以下の項目で構成する。

| 項目           | 概要                                         |
| -------------- | -------------------------------------------- |
| API名          | APIの論理的な名称                            |
| エンドポイント | APIのURL (例: /api/v1/users/list)            |
| メソッド       | HTTPメソッド (GET, POST, PUT, DELETE, PATCH) |
| リクエスト     | リクエスト形式、必須/任意項目、型、制約      |
| レスポンス     | レスポンス形式、フィールド名、型、説明       |
| エラー定義     | HTTPステータスコードとエラーレスポンスの定義 |
